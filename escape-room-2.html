<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pure 1 Escape Room – Exam Vault Heist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2933, #020617);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 1.5rem;
    }
    .container {
      max-width: 900px;
      width: 100%;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 1.75rem 1.75rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    header {
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      padding-bottom: 0.75rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    header p {
      margin: 0.4rem 0 0;
      font-size: 0.95rem;
      color: #9ca3af;
    }
    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    .pill {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .pill span.icon {
      width: 0.6rem;
      height: 0.6rem;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }
    .progress-bar {
      flex: 1;
      min-width: 150px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      height: 10px;
      position: relative;
    }
    .progress-bar-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      transition: width 0.3s ease;
    }
    .lock-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 1.25rem 1.5rem 1.3rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    .lock-title {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .lock-badge {
      font-size: 0.8rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
    }
    .lock-story {
      font-size: 0.95rem;
      color: #9ca3af;
      line-height: 1.5;
    }
    .lock-question {
      font-size: 0.97rem;
      line-height: 1.6;
    }
    .lock-question p { margin: 0.4rem 0; }
    .lock-question ol,
    .lock-question ul { margin: 0.4rem 0 0.4rem 1.2rem; }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-top: 0.2rem;
    }
    label { font-size: 0.9rem; color: #9ca3af; }
    input[type="text"] {
      padding: 0.5rem 0.8rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 1rem;
      width: 160px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 0.7rem;
      padding: 0.5rem 1.1rem;
      font-size: 0.95rem;
      font-weight: 500;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      box-shadow: 0 10px 20px rgba(22, 163, 74, 0.4);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 14px 28px rgba(22, 163, 74, 0.5); }
    button:active { transform: translateY(0); box-shadow: 0 8px 16px rgba(22, 163, 74, 0.4); }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: none;
    }
    .btn-secondary:hover { box-shadow: 0 6px 14px rgba(15, 23, 42, 0.8); }

    .feedback { min-height: 1.25rem; font-size: 0.92rem; margin-top: 0.2rem; }
    .feedback.error { color: #f97373; }
    .feedback.success { color: #22c55e; }

    .footer {
      font-size: 0.8rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 0.6rem;
      flex-wrap: wrap;
      margin-top: 0.4rem;
    }

    .final-message { text-align: center; padding: 1.3rem 0.5rem 0.5rem; }
    .final-message h2 { margin: 0 0 0.4rem; font-size: 1.3rem; }
    .final-message p { margin: 0.2rem 0; font-size: 0.95rem; color: #9ca3af; }

    @media (max-width: 640px) {
      .container { padding: 1.25rem 1rem 1.5rem; }
      header h1 { font-size: 1.3rem; }
      .lock-card { padding: 1rem 0.9rem 1.1rem; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Pure 1 Exam Vault Heist</h1>
      <p>Crack each lock by solving the maths and entering the correct 3-digit code. Unlock all 5 to save the exam.</p>
    </header>

    <div class="status-bar">
      <div class="pill">
        <span class="icon"></span>
        <span id="progress-text">Lock 1 of 5</span>
      </div>
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progress-bar-fill"></div>
      </div>
      <div class="pill">Mode: <strong>Linear</strong></div>
    </div>

    <!-- Student key row -->
    <div class="input-row" style="margin-top:0;">
      <div>
        <label for="student-id-input">Student name/ID:</label><br />
        <input type="text" id="student-id-input" autocomplete="off" />
      </div>
      <button id="set-student-btn" class="btn-secondary">Set</button>
      <div class="pill" style="margin-left:auto">
        Student key: <strong id="student-key">---</strong>
      </div>
    </div>

    <!-- Lock Card -->
    <div class="lock-card" id="lock-card">
      <div class="lock-title">
        <span id="lock-title">Lock 1</span>
        <span class="lock-badge" id="lock-badge">Code: 3 digits</span>
      </div>
      <div class="lock-story" id="lock-story"></div>
      <div class="lock-question" id="lock-question"></div>

      <div class="input-row">
        <div>
          <label for="code-input">Enter 3-digit code:</label><br />
          <input type="text" id="code-input" maxlength="3" autocomplete="off" />
        </div>
        <button id="submit-btn">Submit code <span>⤴</span></button>
        <button class="btn-secondary" id="reset-btn">Reset progress</button>
      </div>
      <div id="feedback" class="feedback"></div>
    </div>

    <!-- Final message -->
    <div id="final-message" class="final-message" style="display:none;">
      <h2>Vault Unlocked!</h2>
      <p>You’ve cracked every lock and completed the Pure 1 escape room.</p>
      <button id="restart-btn" class="btn-secondary">Restart from Lock 1</button>
    </div>

    <div class="footer">
      <span>Tip: Codes do not have spaces. Example: <code>038</code>.</span>
      <span>Teacher override on final lock: <code>911</code>.</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    "use strict";

    // ---------- Student key (deterministic from input) ----------
    const STUDENT_KEY_STORAGE = "escape_student_key_v1";

    function hashToUint32(str) {
      // FNV-1a 32-bit
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function mulberry32(seed) {
      return function () {
        let t = (seed += 0x6D2B79F5);
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function normaliseStudentInput(s) {
      return (s || "").trim().toLowerCase().replace(/\s+/g, " ");
    }

    function computeStudentKeyNumber(studentText) {
      const seed = hashToUint32("PURE1|" + studentText);
      const rng = mulberry32(seed);
      return Math.floor(rng() * 900) + 100; // 100–999
    }

    function format3(n) {
      return String(n).padStart(3, "0");
    }

    function personalisedCode(baseCode, studentKeyNum) {
      return format3((Number(baseCode) + Number(studentKeyNum)) % 1000);
    }

    function getStoredStudent() {
      try { return JSON.parse(localStorage.getItem(STUDENT_KEY_STORAGE) || "null"); }
      catch { return null; }
    }

    function setStoredStudent(obj) {
      try { localStorage.setItem(STUDENT_KEY_STORAGE, JSON.stringify(obj)); }
      catch {}
    }

    // ---------- DOM ----------
    const lockTitleEl = document.getElementById("lock-title");
    const lockBadgeEl = document.getElementById("lock-badge");
    const lockStoryEl = document.getElementById("lock-story");
    const lockQuestionEl = document.getElementById("lock-question");
    const codeInputEl = document.getElementById("code-input");
    const submitBtn = document.getElementById("submit-btn");
    const resetBtn = document.getElementById("reset-btn");
    const feedbackEl = document.getElementById("feedback");
    const progressTextEl = document.getElementById("progress-text");
    const progressBarFill = document.getElementById("progress-bar-fill");
    const lockCardEl = document.getElementById("lock-card");
    const finalMessageEl = document.getElementById("final-message");
    const restartBtn = document.getElementById("restart-btn");

    const studentInputEl = document.getElementById("student-id-input");
    const setStudentBtn = document.getElementById("set-student-btn");
    const studentKeyEl = document.getElementById("student-key");

    // ---------- Progress ----------
    const PROGRESS_KEY = "pure1EscapeProgress_v1";
    function saveProgress(index) { try { localStorage.setItem(PROGRESS_KEY, String(index)); } catch (_) {} }
    function loadProgress() {
      try {
        const raw = localStorage.getItem(PROGRESS_KEY);
        if (raw === null) return 0;
        const idx = parseInt(raw, 10);
        return Number.isFinite(idx) && idx >= 0 ? idx : 0;
      } catch (_) { return 0; }
    }
    function clearProgress() { try { localStorage.removeItem(PROGRESS_KEY); } catch (_) {} }

    // ---------- Student key state ----------
    function ensureStudentIsSet() {
      const stored = getStoredStudent();
      if (stored?.text && Number.isFinite(stored?.keyNum)) {
        studentKeyEl.textContent = format3(stored.keyNum);
        studentInputEl.value = stored.text;
        return stored.keyNum;
      }
      studentKeyEl.textContent = "---";
      return null;
    }

    let studentKeyNum = ensureStudentIsSet();

    setStudentBtn.addEventListener("click", () => {
      const text = normaliseStudentInput(studentInputEl.value);
      if (!text) return;

      studentKeyNum = computeStudentKeyNumber(text);
      setStoredStudent({ text, keyNum: studentKeyNum });
      studentKeyEl.textContent = format3(studentKeyNum);

      // Optional: restart when student changes
      currentIndex = 0;
      clearProgress();
      showLock(currentIndex);
    });

    // ---------- Locks (TOTAL = 5) ----------
    const locks = [
      {
        title: "Lock 1 – Binomial Coefficient Scanner",
        story: "A scanner reads only one term from the expansion. Find the coefficient of x, then apply your personal key.",
        questionHtml: `
          <p><strong>Your personal key:</strong> <span class="student-key-inline">---</span></p>
          <p>Find the coefficient of <math><mi>x</mi></math> in the expansion</p>
          <p style="text-align:center;">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
              <msup>
                <mrow>
                  <mo>(</mo>
                  <mfrac><mi>x</mi><mn>3</mn></mfrac>
                  <mo>+</mo>
                  <mfrac><mn>9</mn><msup><mi>x</mi><mn>2</mn></msup></mfrac>
                  <mo>)</mo>
                </mrow>
                <mn>7</mn>
              </msup>
            </math>
          </p>

          <p><strong>Final lock code rule:</strong></p>
          <p>
            Take the 3-digit number you found (here it’s the coefficient, written as 3 digits like <code>007</code>),
            add your personal key, and keep only the last three digits.
          </p>
        `,
        baseCode: 7 // coefficient is 7 -> treat as 007
      },
      {
        title: "Lock 2 – Bounce-Model Sensor",
        story: "Model the bounces and convert your final result into a 3-digit base code, then apply your personal key.",
        questionHtml: `
          <p><strong>Your personal key:</strong> <span class="student-key-inline">---</span></p>

          <p>A ball is such that when it is dropped from a height of 1 metre it bounces vertically from the ground
          to a height of 0.96 metres. Two models describe this:</p>

          <p><strong>Model A:</strong> reduce by 0.04 m each bounce.<br>
          <strong>Model B:</strong> reduce by 4% each bounce.</p>

          <ol>
            <li>Find the total vertical distance (up and down) from the 1st hit until the 21st hit:
              <ol type="a"><li>Model A</li><li>Model B</li></ol>
            </li>
            <li>Show that under Model B the total distance cannot exceed 48 m.</li>
          </ol>

          <p><strong>Teacher note:</strong> base code is taken from part (i)(a) using your class rule.</p>
        `,
        baseCode: 232
      },
      {
        title: "Lock 3 – Composite Function Gate",
        story: "Find the domain condition for gf, then solve the follow-up equation to generate your base code.",
        questionHtml: `
          <p><strong>Your personal key:</strong> <span class="student-key-inline">---</span></p>

          <p><code>f(x)=3x+1</code> for <code>x ≤ a</code>. <code>g(x)=−1−x²</code> for <code>x ≤ −1</code>.</p>

          <ol>
            <li>Find the largest value of <code>a</code> for which <code>g∘f</code> can be formed.</li>
            <li>For <code>a=-1</code>, solve <code>f(g(x)) + 14 = 0</code>.</li>
          </ol>

          <p><strong>Teacher note:</strong> base code uses your class rule.</p>
        `,
        baseCode: 322
      },
      {
        title: "Lock 4 – Motion Sensor Calculus",
        story: "Link dy/dx and dx/dt, then use tangent/normal geometry at A to get the triangle area base code.",
        questionHtml: `
          <p><strong>Your personal key:</strong> <span class="student-key-inline">---</span></p>

          <p>A curve passes through <code>A(4,6)</code> and</p>
          <p style="text-align:center;">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
              <mfrac><mrow><mi>dy</mi></mrow><mrow><mi>dx</mi></mrow></mfrac>
              <mo>=</mo><mn>1</mn><mo>+</mo><mn>2</mn><msup><mi>x</mi><mrow><mo>-</mo><mn>2</mn></mrow></msup>
            </math>
          </p>
          <p><code>dx/dt = 3</code> units/min.</p>

          <ol>
            <li>Find <code>dy/dt</code> at A.</li>
            <li>Find the equation of the curve.</li>
            <li>Find the area of triangle ABC from tangent/normal intercepts.</li>
          </ol>

          <p><strong>Teacher note:</strong> base code is from the area rule you set.</p>
        `,
        baseCode: 145
      },
      {
        title: "Lock 5 – Trig Override Seal",
        story: "Convert to a quadratic in cosθ, then solve in 0° ≤ θ ≤ 360° to obtain the base code.",
        questionHtml: `
          <p><strong>Your personal key:</strong> <span class="student-key-inline">---</span></p>

          <p>Show that</p>
          <p style="text-align:center;">
            <math xmlns="http://www.w3.org/1998/Math/MathML">
              <mfrac><mn>1</mn><mrow><mi>cos</mi><mi>&#952;</mi></mrow></mfrac>
              <mo>+</mo><mn>3</mn><mi>sin</mi><mi>&#952;</mi><mi>tan</mi><mi>&#952;</mi>
              <mo>+</mo><mn>4</mn><mo>=</mo><mn>0</mn>
            </math>
          </p>

          <ol>
            <li>Show this becomes <code>3cos²θ − 4cosθ − 4 = 0</code>.</li>
            <li>Hence solve for <code>0° ≤ θ ≤ 360°</code> (1 d.p.).</li>
          </ol>

          <p><strong>Teacher note:</strong> base code comes from your p/q digit rule.</p>
        `,
        baseCode: 328
      }
    ];

    // ---------- Game state ----------
    let currentIndex = loadProgress();
    if (currentIndex > locks.length) currentIndex = 0;

    function updateProgress() {
      const total = locks.length;
      const currentDisplay = Math.min(currentIndex + 1, total);
      progressTextEl.textContent = `Lock ${currentDisplay} of ${total}`;
      progressBarFill.style.width = ((currentIndex / total) * 100) + "%";
    }

    function expectedCode(lock) {
      if (!Number.isFinite(studentKeyNum)) return null; // must set student first
      return personalisedCode(lock.baseCode, studentKeyNum);
    }

    function renderStudentKeyInline() {
      const els = lockQuestionEl.querySelectorAll(".student-key-inline");
      els.forEach(el => el.textContent = Number.isFinite(studentKeyNum) ? format3(studentKeyNum) : "---");
    }

    function showLock(index) {
      const lock = locks[index];

      lockTitleEl.textContent = lock.title;
      lockStoryEl.textContent = lock.story;
      lockQuestionEl.innerHTML = lock.questionHtml;
      renderStudentKeyInline();

      lockBadgeEl.textContent = "Code: 3 digits";
      codeInputEl.value = "";
      codeInputEl.disabled = false;
      submitBtn.disabled = false;

      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";

      lockCardEl.style.display = "block";
      finalMessageEl.style.display = "none";

      updateProgress();
      codeInputEl.focus();
    }

    function showFinal() {
      lockCardEl.style.display = "none";
      finalMessageEl.style.display = "block";
      progressTextEl.textContent = "Complete";
      progressBarFill.style.width = "100%";
    }

    function normaliseCodeInput(value) {
      return (value || "").replace(/\s+/g, "");
    }

    function checkCode() {
      if (!Number.isFinite(studentKeyNum)) {
        feedbackEl.textContent = "Set your Student name/ID first (to generate your Student key).";
        feedbackEl.className = "feedback error";
        return;
      }

      const input = normaliseCodeInput(codeInputEl.value);
      if (!/^\d{3}$/.test(input)) {
        feedbackEl.textContent = "Codes are exactly 3 digits (0–9 only).";
        feedbackEl.className = "feedback error";
        return;
      }

      const lock = locks[currentIndex];
      const expected = expectedCode(lock);

      const isFinalLock = currentIndex === locks.length - 1;
      const ok = (input === expected) || (isFinalLock && input === "911");

      if (!ok) {
        feedbackEl.textContent = "Incorrect code. Check your working and try again.";
        feedbackEl.className = "feedback error";
        codeInputEl.select();
        return;
      }

      feedbackEl.textContent = "Correct code! Lock opened.";
      feedbackEl.className = "feedback success";
      codeInputEl.disabled = true;
      submitBtn.disabled = true;

      if (typeof confetti === "function") {
        confetti({ particleCount: 120, spread: 70, origin: { y: 0.7 } });
      }

      setTimeout(() => {
        currentIndex++;
        saveProgress(currentIndex);

        if (currentIndex >= locks.length) showFinal();
        else showLock(currentIndex);
      }, 650);
    }

    function resetProgress() {
      if (!confirm("Reset all progress and go back to Lock 1?")) return;
      currentIndex = 0;
      clearProgress();
      showLock(currentIndex);
    }

    submitBtn.addEventListener("click", checkCode);
    resetBtn.addEventListener("click", resetProgress);
    restartBtn.addEventListener("click", resetProgress);
    codeInputEl.addEventListener("keyup", (e) => { if (e.key === "Enter") checkCode(); });

    // Init
    if (currentIndex >= locks.length) showFinal();
    else showLock(currentIndex);
  </script>
</body>
</html>